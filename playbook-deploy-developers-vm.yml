---
- name: Deploy developers VM
  hosts: all
  become: yes

  tasks:

  #- name: Run apt upgrade
  #  apt:
  #    upgrade: "yes"
  #    update_cache: yes
  #    cache_valid_time: 432000

  #- name: Add universe repository into sources list
  #  apt_repository:
  #    repo: deb http://archive.ubuntu.com/ubuntu $(lsb_release -sc) universe
  #    state: present

  - name: Install some system tools
    ansible.builtin.apt:
       name:
          - apt-transport-https
          - htop
          - mc
          - net-tools
          - libc6
       state: latest
       update_cache: true

  - name: Install DotNet SDK 6.0
    ansible.builtin.apt:
       name:
          - dotnet-sdk-6.0
       state: latest
       update_cache: true

   - name: Download packages-microsoft-prod.deb
     ansible.builtin.get_url:
       url: https://packages.microsoft.com/config/ubuntu/22.10/packages-microsoft-prod.deb
       dest: /usr/src/packages-microsoft-prod.deb
       mode: '0440'

  #- name: Install DotNetCore 6.0
  #  ansible.builtin.snap:
  #     name: dotnet-sdk
  #     channel: 6.0
  #     classic: yes
  #     state: present

  - name: Chmod o-x rsync
    ansible.builtin.file:
        path: /usr/bin/rsync
        owner: root
        group: root
        mode: '0644'

  - name: Replace sftp config
    ansible.builtin.replace:
        path: /etc/ssh/sshd_config
        regexp: '(^Subsystem sftp\s)(.*)$'
        replace: 'Subsystem sftp internal-sftp -P read, remove'

  - name: Restart sshd
    service:
        name: ssh
        state: restarted

  #- name: Clone GP from github
  #  ansible.builtin.git:
  #      repo: 'https://github.com/rmtteam/gp-deploy-developers-vm.git'
  #      dest: /usr/src/gp-deploy-developers-vm

  #- name: Remove playbook-deploy-developers-vm.yml
  #  ansible.builtin.file:
  #      path: /usr/src/gp-deploy-developers-vm/playbook-deploy-developers-vm.yml
  #      state: absent

  - name: Add a group Developer
    group:
        name: developer
        state: present

  - name: Add a user Developer
    user:
        name: developer
        password: $6$dZjGIVaxZmY7$lr8NX9BARnkklMWcgcXvZ4KHK7Oc4JHqxPAR./St7hEDv8lhwV7WtrguIfnJVwYsAh8jbj3K.xBu2GWGSxmX50
        shell: /bin/bash
        update_password: on_create
        groups: developer
        append: yes
        # mkpasswd --method=sha-512 LvHgB7l5XQ8K

  - name: Create a directory /bin
    file:
        path: /home/developer/bin
        state: directory
        mode: '0755'


  #- name: Copy .bash_profile to home folder
  #  shell:
  #        "cp /usr/src/gp-deploy-developers-vm/.bash_profile /home/developer/.bash_profile"
